{{- /* Generate the optimized search index - Updated to include all tags */ -}}
{{- $index := slice -}}
{{- $pages := site.RegularPages -}}
{{- /* Add the index page of docs separately since it's not in RegularPages above. */ -}}
{{- $pages := $pages | union (where (where site.Pages "Kind" "section") "Type" "docs") -}}
{{- /* Add author pages to index so their bios can be searched. Hide empty `/authors/` node. */ -}}
{{- $pages := $pages | union (where (where site.Pages "Section" "authors") "Params.name" "!=" nil) -}}

{{- range $pages -}}
  {{- /* Do not index drafts or private pages. */ -}}
  {{- if and (not .Draft) (not .Params.private) -}}
    
    {{- /* Skip blog posts (Section = "post") that don't have the "s" tag */ -}}
    {{- $shouldIndex := true -}}
    {{- /* Skip authors section as we index bio widget separately */ -}}
    {{- if eq .Section "authors" -}}
      {{- $shouldIndex = false -}}
    {{- else if eq .Section "post" -}}
      {{- $hasStag := false -}}
      {{- range .Params.Tags -}}
        {{- if eq . "s" -}}
          {{- $hasStag = true -}}
        {{- end -}}
      {{- end -}}
      {{- if not $hasStag -}}
        {{- $shouldIndex = false -}}
      {{- end -}}
    {{- end -}}
    
    {{- if $shouldIndex -}}

    {{- /* Generate page description. */ -}}
    {{- $desc := "" -}}
    {{- if .Params.summary -}}
      {{- $desc = .Params.summary | truncate 200 -}}
    {{- else if .Params.abstract -}}
      {{- $desc = .Params.abstract | truncate 200 -}}
    {{- else -}}
      {{- $desc = .Summary | truncate 200 -}}
    {{- end -}}

    {{- $authors := .Params.authors -}}
    {{- $title := .Title}}
    {{- $rel_permalink := .RelPermalink -}}
    {{- $permalink := .Permalink -}}

    {{/* Correct the title and URL for author profile pages. */}}
    {{- if eq .Section "authors" -}}
      {{- $title = .Params.name -}}
      {{- $username := path.Base (path.Split .Path).Dir -}}
      {{- with site.GetPage (printf "/authors/%s" $username) -}}
        {{- $permalink = .Permalink -}}
        {{- $rel_permalink = .RelPermalink -}}
      {{- end -}}
    {{- else -}}
      {{/* Include a user's display name rather than username where possible. */}}
      {{- if .Params.authors -}}
        {{- $authorLen := len .Params.authors -}}
        {{- if gt $authorLen 0 -}}
          {{- $authors = slice -}}
            {{- range $k, $v := .Params.authors -}}
              {{- $person_page_path := (printf "/authors/%s" (anchorize $v)) -}}
              {{- $person_page := site.GetPage $person_page_path -}}
              {{- if and $person_page $person_page.File -}}
                {{- $person := $person_page.Params -}}
                {{- $authors = $authors | append $person.name -}}
              {{- else -}}
                {{- $authors = $authors | append ($v | plainify) -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
    {{- end -}}

    {{- /* OPTIMIZATION: Create much smaller content excerpt instead of full content */ -}}
    {{- $content := .Plain -}}
    {{- $contentExcerpt := "" -}}
    {{- /* Use larger excerpt for author pages to capture full bio */ -}}
    {{- $excerptSize := 500 -}}
    {{- if eq .Section "authors" -}}
      {{- $excerptSize = 3000 -}}
    {{- end -}}
    {{- if gt (len $content) $excerptSize -}}
      {{- $contentExcerpt = substr $content 0 $excerptSize -}}
      {{- /* Simple truncation without word boundary detection for compatibility */ -}}
    {{- else -}}
      {{- $contentExcerpt = $content -}}
    {{- end -}}

    {{- /* Include all tags instead of limiting to 5 */ -}}
    {{- $limitedTags := slice -}}
    {{- if .Params.Tags -}}
      {{- range .Params.Tags -}}
        {{- $limitedTags = $limitedTags | append . -}}
      {{- end -}}
    {{- end -}}

    {{- $limitedCategories := slice -}}
    {{- if .Params.Categories -}}
      {{- range first 3 .Params.Categories -}}
        {{- $limitedCategories = $limitedCategories | append . -}}
      {{- end -}}
    {{- end -}}

    {{- /* OPTIMIZATION: Limit authors */ -}}
    {{- $limitedAuthors := slice -}}
    {{- if $authors -}}
      {{- range first 3 $authors -}}
        {{- $limitedAuthors = $limitedAuthors | append . -}}
      {{- end -}}
    {{- end -}}

    {{- /* Add page to index with optimized content. */ -}}
    {{- $index = $index | append (dict "objectID" .File.UniqueID "date" .Date.UTC.Unix "publishdate" .PublishDate "lastmod" .Lastmod.UTC.Unix "lang" .Lang "permalink" $permalink "relpermalink" $rel_permalink "title" ($title | plainify) "summary" (plainify $desc) "content" (plainify $contentExcerpt) "authors" $limitedAuthors "kind" .Kind "type" .Type "section" .Section "tags" $limitedTags "categories" $limitedCategories) -}}

    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Add home page with all widget content combined for searchability */ -}}
{{- $homePage := site.GetPage "/" -}}
{{- if $homePage -}}
  {{- $homeContent := "" -}}
  {{- $homeWidgets := slice -}}
  
  {{- /* Try to read home widget files from filesystem */ -}}
  {{- range (readDir "content/home") -}}
    {{- if and (not .IsDir) (ne .Name "index.md") (or (strings.HasSuffix .Name ".md") (strings.HasSuffix .Name ".markdown")) -}}
      {{- $widgetPath := printf "content/home/%s" .Name -}}
      {{- $widgetContent := readFile $widgetPath -}}
      {{- /* Check if widget is active */ -}}
      {{- $activeMatch := findRE `(?m)^active\s*=\s*(true|false)` $widgetContent 1 -}}
      {{- $isActive := true -}}
      {{- if $activeMatch -}}
        {{- if in (index $activeMatch 0) "false" -}}
          {{- $isActive = false -}}
        {{- end -}}
      {{- end -}}
      {{- /* Extract title from front matter - look for title = "..." */ -}}
      {{- $titleMatch := findRE `(?m)^title\s*=\s*"([^"]+)"` $widgetContent 1 -}}
      {{- $widgetTitle := "" -}}
      {{- if $titleMatch -}}
        {{- $widgetTitle = replaceRE `(?m)^title\s*=\s*"([^"]+)"` "$1" (index $titleMatch 0) -}}
      {{- end -}}
      {{- /* Remove front matter to get content */ -}}
      {{- $cleanContent := replaceRE `(?s)^\+\+\+.*?\+\+\+` "" $widgetContent -}}
      {{- $cleanContent = replaceRE `(?s)^---.*?---` "" $cleanContent -}}
      {{- if and $widgetTitle $isActive -}}
        {{- $homeContent = printf "%s\n\n## %s\n\n%s" $homeContent $widgetTitle $cleanContent -}}
        {{- $homeWidgets = $homeWidgets | append (dict "title" $widgetTitle "id" (replace (replace .Name ".md" "") ".markdown" "") "content" $cleanContent) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Add individual entries for each widget section */ -}}
  {{- range $homeWidgets -}}
    {{- $sectionID := .id -}}
    {{- $sectionTitle := .title -}}
    {{- $sectionContent := .content -}}
    {{- $permalink := printf "%s#%s" site.BaseURL $sectionID -}}
    {{- $relpermalink := printf "/#%s" $sectionID -}}
    {{- $uniqueID := printf "home-widget-%s" $sectionID -}}
    
    {{- $index = $index | append (dict "objectID" $uniqueID "date" 0 "publishdate" "0001-01-01T00:00:00Z" "lastmod" 0 "lang" "en" "permalink" $permalink "relpermalink" $relpermalink "title" $sectionTitle "summary" $sectionTitle "content" (plainify $sectionContent) "authors" slice "kind" "home" "type" "home" "section" $sectionTitle "tags" slice "categories" slice) -}}
  {{- end -}}
  
  {{- /* Add bio widget separately since it pulls content from author profile */ -}}
  {{- $authorPage := site.GetPage "/authors/admin" -}}
  {{- if $authorPage -}}
    {{- $bioContent := $authorPage.Plain -}}
    {{- $bioExcerpt := $bioContent -}}
    {{- if gt (len $bioContent) 3000 -}}
      {{- $bioExcerpt = substr $bioContent 0 3000 -}}
    {{- end -}}
    {{- $bioPermalink := printf "%s#bio" site.BaseURL -}}
    {{- $bioRelpermalink := "/#bio" -}}
    {{- $index = $index | append (dict "objectID" "home-widget-bio" "date" 0 "publishdate" "0001-01-01T00:00:00Z" "lastmod" 0 "lang" "en" "permalink" $bioPermalink "relpermalink" $bioRelpermalink "title" "Profile" "summary" "Profile of Pablo Bernabeu" "content" (plainify $bioExcerpt) "authors" slice "kind" "home" "type" "home" "section" "Profile" "tags" slice "categories" slice) -}}
  {{- end -}}
{{- end -}}

{{- $index | jsonify -}}
