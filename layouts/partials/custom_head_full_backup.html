{{/* Custom head additions */}}

{{/* Prevent white flash on dark theme load */}}
<script>
  (function () {
    "use strict";

    // Get saved theme preference or default to auto
    function getThemeMode() {
      return parseInt(localStorage.getItem("dark_mode") || 2);
    }

    function shouldUseDarkTheme() {
      let currentThemeMode = getThemeMode();
      switch (currentThemeMode) {
        case 0:
          return false; // Light mode
        case 1:
          return true; // Dark mode
        default:
          // Auto mode - only apply if user has explicitly chosen auto mode
          // Otherwise, default to light theme for new visitors
          if (localStorage.getItem("dark_mode") === null) {
            return false; // No preference saved, use light theme by default
          }
          return (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
          );
      }
    }

    // Apply theme immediately before page renders
    if (shouldUseDarkTheme()) {
      document.documentElement.style.backgroundColor = "#0f172a";
      document.documentElement.style.color = "#e2e8f0";
    }
  })();
</script>

<style>
  /* Ensure smooth transitions */
  html,
  body {
    transition: background-color 0.15s ease, color 0.15s ease;
  }

  /* Performance optimizations */
  /* Font display optimization */
  @font-face {
    font-family: system;
    font-style: normal;
    font-weight: 300;
    src: local(".SFNSText-Light"), local(".HelveticaNeueDeskInterface-Light"),
      local(".LucidaGrandeUI"), local("Ubuntu Light"), local("Segoe UI Light"),
      local("Roboto-Light"), local("DroidSans"), local("Tahoma");
  }

  /* Fallback fonts */
  body {
    font-family: system, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      "Helvetica Neue", Arial, sans-serif;
  }

  /* Critical CSS for above-the-fold content */
  .navbar {
    will-change: transform;
  }

  .hero-media {
    will-change: auto;
  }

  /* Reduce layout shifts */
  img {
    height: auto;
    max-width: 100%;
  }

  /* Image optimization styles */
  img.lazy-loading {
    opacity: 0.7;
    transition: opacity 0.3s;
  }

  img.lazy-loaded {
    opacity: 1;
  }

  /* Optimize animations */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Ultra-performance mode styles */
  .search-disabled {
    opacity: 0.6;
    cursor: pointer;
  }
  .search-loading {
    opacity: 0.8;
  }

  /* Critical layout prevention */
  .content-wrapper {
    min-height: 50vh;
  }
</style>

<!-- Load critical performance CSS -->
<link rel="stylesheet" href="{{ "css/critical-performance.css" | relURL }}"
media="print" onload="this.media='all'; this.onload=null;"> {{/* Preconnect to
external domains */}}
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="dns-prefetch" href="https://www.google-analytics.com" />

{{/* Smart prefetch - only on fast connections after initial load */}}
<script>
  // Smart prefetch strategy
  setTimeout(function () {
    if (
      navigator.connection &&
      navigator.connection.effectiveType !== "slow-2g"
    ) {
      var link = document.createElement("link");
      link.rel = "prefetch";
      link.href = '{{ "index.json" | relURL }}';
      link.as = "fetch";
      link.crossOrigin = "anonymous";
      document.head.appendChild(link);
      console.log("ðŸ“¡ Prefetching search index...");
    }
  }, 3000);
</script>

{{/* Performance optimization meta tags */}}
<meta name="format-detection" content="telephone=no" />

{{/* All custom JavaScript temporarily disabled to fix search functionality */}}
{{/* Service Worker registration */}} {{ if not (.Scratch.Get "dev_mode") }}
<script>
  if ("serviceWorker" in navigator && window.location.protocol === "https:") {
    window.addEventListener("load", function () {
      navigator.serviceWorker
        .register('{{ "sw.js" | relURL }}')
        .then(function (registration) {
          console.log("SW registered: ", registration.scope);
        })
        .catch(function (registrationError) {
          console.log("SW registration failed: ", registrationError);
        });
    });
  }
</script>
{{ end }} {{/* Performance monitoring */}}
<script>
  // Core Web Vitals measurement
  if ("PerformanceObserver" in window) {
    // Largest Contentful Paint
    new PerformanceObserver(function (list) {
      var entries = list.getEntries();
      var lastEntry = entries[entries.length - 1];
      console.log("LCP:", Math.round(lastEntry.startTime) + "ms");
    }).observe({ entryTypes: ["largest-contentful-paint"] });

    // First Input Delay
    new PerformanceObserver(function (list) {
      list.getEntries().forEach(function (entry) {
        console.log(
          "FID:",
          Math.round(entry.processingStart - entry.startTime) + "ms"
        );
      });
    }).observe({ entryTypes: ["first-input"] });
  }

  // Page load timing
  window.addEventListener("load", function () {
    setTimeout(function () {
      var loadTime =
        performance.timing.loadEventEnd - performance.timing.navigationStart;
      var domContentLoaded =
        performance.timing.domContentLoadedEventEnd -
        performance.timing.navigationStart;

      console.log("Page Load Time:", loadTime + "ms");
      console.log("DOM Content Loaded:", domContentLoaded + "ms");
    }, 0);
  });
</script>

{{/* Search configuration temporarily removed to test theme switching */}}

{{/* IndexNow automatic submission */}}
{{ if site.Params.indexnow.enabled }}
<script>
  window.addEventListener("load", function () {
    if (typeof IndexNowSubmission !== "undefined") {
      setTimeout(function () {
        IndexNowSubmission.submitCurrentPage();
      }, 2000);
    }
  });
</script>
{{ end }}
